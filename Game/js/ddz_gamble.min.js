ddz.startGamble=function(a,b){this.scoreRate=this.baseScore=1;this.dizhu=null;this.gambleData||(this.gambleData={});this.gambleData.interval=1500;this.gambleData.stage=a;this.gambleData.pokers=b;this.gambleData.player=null;this.gambleData.score=0;this.gambleData.turn=-1;this.gambleData.count=0;this.gambleData.total=3;this.gambleData.rect=[];AI.sort1(this.user.pokers);this.resortPokers(!0,!1);this.pokerStage.render();this.determineGambleStart();this.processGamble()};
ddz.determineGambleStart=function(){this.gambleData.turn=Math.floor(Math.random()*this.players.length);this.gambleData.turn=1};ddz.processGamble=function(){if(this.gambleData.count>=this.gambleData.total||3<=this.gambleData.score)this.onGambleComplete();else{var a=this.players[this.gambleData.turn],b=AI.gamble(a);if(0==this.gambleData.turn)this.showGambleButtons(!0,this.gambleData.score);else this.onGambleResult(a,b)}};
ddz.onGambleResult=function(a,b){trace("gamble:",a,b,a.pokerScore,a.pokers);b>this.gambleData.score?(this.gambleData.player=a,this.gambleData.score=b):b=0;switch(this.gambleData.turn){case 0:this.showGambleButtons(!1);break;case 1:UI.showBubble(!0,"gamble"+b,!0,this.infoStage,this.width-100,40);this.gambleData.rect[1]=new Rectangle(this.width-100-42,40,84,48);break;case 2:UI.showBubble(!0,"gamble"+b,!1,this.infoStage,100,40),this.gambleData.rect[2]=new Rectangle(58,40,84,48)}if(a==this.user&&3<=b||
this.gambleData.count==this.gambleData.total-1)this.onGambleComplete();else this.gambleData.turn=this.gambleData.turn<this.gambleData.total-1?++this.gambleData.turn:0,this.gambleData.count++,setTimeout(casual.delegate(this.processGamble,this),this.gambleData.interval)};
ddz.onGambleComplete=function(){trace("onGambleComplete:",this.gambleData.player,this.gambleData.score);if(null==this.gambleData.player)trace("no gamble, restart"),this.resetGame();else{this.showGambleButtons(!1);var a=this.gambleData.rect[1];a&&this.infoStage.clear(a.x,a.y,a.width,a.height);(a=this.gambleData.rect[2])&&this.infoStage.clear(a.x,a.y,a.width,a.height);this.gambleData.rect=null;this.baseScore=this.gambleData.score;this.setDiZhu(this.gambleData.player);for(var b=this.gambleData.stage,
a=this.gambleData.pcount=0;3>a;a++)TweenUtil.to(b[a].canvas,this.playTween?200:0,{y:-60,onUpdate:function(){this.target.style.left=this.target.x+"px";this.target.style.top=this.target.y+"px"},onComplete:function(){this.target.style.left=this.target.x+"px";this.target.style.top=this.target.y+"px";3<=++ddz.gambleData.pcount&&(ddz.clearGambleStage(),delete ddz.gambleData.pcount,ddz.startPlay())}});a=0;for(b=this.gambleData.pokers.length;a<b;a++){var c=this.gambleData.pokers[a],c=new Poker(c.point,c.type,
"s");c.x=a*c.width+2;c.y=1;c.mouseEnabled=!1;UI.toolbar.lastPokers.addChild(c)}this.infoStage.addChild(UI.toolbar.lastPokers);UI.toolbar.lastPokers.fastRender(this.infoStage.context);UI.toolbar.container.addChild(UI.toolbar.scoreText);UI.toolbar.container.addChild(UI.toolbar.baseText);this.infoStage.addChild(UI.toolbar.scoreRate);this.infoStage.addChild(UI.toolbar.baseScore);UI.toolbar.container.fastRender(this.infoStage.context);this.setBaseScoreAndRate(this.baseScore,this.scoreRate);this.gambleData.turn=
-1;this.gambleData.count=0;this.gambleData.score=0;this.gambleData.player=null}};ddz.clearGambleStage=function(){var a=this.gambleData?this.gambleData.stage:null;if(a){for(var b=0;3>b;b++){var c=a[b];c.removeAllChildren();this.container.removeChild(c.canvas)}ddz.gambleData.stage=null}};ddz.setBaseScoreAndRate=function(a,b){b&&UI.renderNumber(this.infoStage.context,UI.toolbar.scoreRate,b,!0,!0);a&&UI.renderNumber(this.infoStage.context,UI.toolbar.baseScore,a,!0,!0)};
ddz.setDiZhu=function(a){trace("setDiZhu:",a);this.dizhu=a;a.setPortrait(R.playerDizhu);a.fastRender(this.playerStage.context);a.pokers=a.pokers.concat(this.gambleData.pokers);this.resortPokers(!0,!0);this.pokerStage.render();a!=this.user&&(AI.sort1(a.pokers),UI.renderNumber(this.playerStage.context,a.pokerCount,a.pokers.length))};
ddz.showGambleButtons=function(a,b){if(!this.gambleBtns){var c=new Sprite;this.gambleBtns=c;var e=UI.noGambleBtn;e.x=20;e.id=0;var d=UI.gambleBtn3;d.x=this.controlStage.getStageWidth()-d.width;d.id=3;var f=UI.gambleBtn2;f.x=d.x-f.width-10;f.id=2;var g=UI.gambleBtn1;g.x=f.x-g.width-10;g.id=1;c.addChild(e);c.addChild(g);c.addChild(f);c.addChild(d);e.onMouseUp=g.onMouseUp=f.onMouseUp=d.onMouseUp=function(a){this.stage=null;ddz.onGambleResult(ddz.user,a.target.id)}}if(a){if(0<b)for(c=1,e=this.gambleBtns.getNumChildren();c<
e;c++)d=this.gambleBtns.getChildAt(c),d.id<=b&&d.setState(Button.state.DISABLED);this.controlStage.addChild(this.gambleBtns);this.gambleBtns.fastRender(this.controlStage.context)}else this.controlStage.removeChild(this.gambleBtns),this.controlStage.clear()};
