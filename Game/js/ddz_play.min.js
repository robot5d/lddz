ddz.startPlay=function(){this.turnWinner=null;this.turnInterval=1500;this.playTurn=this.players.indexOf(this.dizhu);this.lastWinner=this.lastType=this.lastPokers=null;this.lastRect=[];this.lastTip=null;this.lastTipIndex=0;this.nextTurn(!1)};ddz.getNextTurn=function(){return this.playTurn<this.players.length-1?this.playTurn+1:0};
ddz.nextTurn=function(a){if(a){var b=this.players[this.playTurn];this.playTurn=this.getNextTurn()}a=this.players[this.playTurn];a.clearLastPokers();a.addGlow();a.fastRender(this.playerStage.context);a==this.lastWinner&&(this.freePlayer=this.lastType=this.lastPokers=null);b&&(b.fastClear(new Rectangle(b.x-7,b.y-7,b.width+15,b.height+22)),this.playerStage.addChild(b),b.fastRender(this.playerStage.context));(b=this.lastRect[this.playTurn])&&(0==this.playTurn?this.playerStage:this.infoStage).clear(b.x,
b.y,b.width,b.height);a==this.user?(this.lastTip=null,this.lastTipIndex=0,this.showControlButtons(!0)):setTimeout(casual.delegate(this.processTurn,this),this.turnInterval)};
ddz.processTurn=function(){var a=this.players[this.playTurn],b=0==this.playTurn?this.players[2]:1==this.playTurn?this.players[0]:this.players[1],d=0==this.playTurn?this.players[1]:1==this.playTurn?this.players[2]:this.players[0],b=a!=this.dizhu?this.dizhu:b.pokers.length<d.pokers.length?b:d;if(this.lastType){var c=AI.findBestPokers(a,this.lastType,this.lastPokers,!0);trace("findBestPokers:",a,this.lastType,c,this.lastPokers);if(c&&c.length<a.pokers.length){if(a!=this.dizhu&&this.lastWinner!=this.dizhu){if(d==
this.lastWinner&&d==this.freePlayer){this.skipPlay(a);return}d=AI.findBestPokers(d,this.lastType,this.lastPokers,!1);if((!d||0==d.length)&&AI.hasChance(95)){this.skipPlay(a);return}d=AI.sort1(c);if((15<=this.lastPokers[0].point||16<=d[0].point)&&4<a.pokers.length-d.length&&AI.hasChance(80)){this.skipPlay(a);return}if(1<d.length&&14<=d[0].point&&a.pokers.length-d.length>this.lastWinner.pokers.length&&AI.hasChance(80)){this.skipPlay(a);return}if(3<=d.length&&15==d[0].point&&15==d[1].point&&15==d[2].point&&
5<b.pokers.length){this.skipPlay(a);return}}d=Rule.getType(c);if(d==GroupType.\u9410\u7a3f\u810a||d==GroupType.\u9359\u5c80\u5e07)if(this.lastType==GroupType.\u9357\u66de\u7d36&&d==GroupType.\u9359\u5c80\u5e07&&0==a.bomb.length&&10>b.pokers.length)c=c[1];else if(5<b.pokers.length){if(8<a.pokers.length-c.length&&AI.hasChance(90)){this.skipPlay(a);return}if(5<a.pokers.length-c.length&&AI.hasChance(60)){this.skipPlay(a);return}}1==b.pokers.length&&this.lastType==GroupType.\u9357\u66de\u7d36?(b=AI.findAllByType(a,
GroupType.\u9357\u66de\u7d36,this.lastPokers,!1),0<b.length&&(c=b[0])):2==b.pokers.length&&this.lastType==GroupType.\u7035\u7470\u74d9&&Rule.getType(b.pokers)==GroupType.\u7035\u7470\u74d9&&(b=AI.findAllByType(a,GroupType.\u7035\u7470\u74d9,this.lastPokers,!1),0<b.length&&(c=b[0]));Poker.select(c,!0);this.playPoker(a)}else c?(Poker.select(c,!0),this.playPoker(a)):this.skipPlay(a)}else{d=AI.findBestPokers(a,null,null,!0);if(d.length!=a.pokers.length){AI.analyzePlayerPokers(b);var e=AI.filterPokers(a.pokers,
d);if(Rule.getType(e)&&e[0].point>=b.pokers[0].point)c=e;else{if(5>=b.pokers.length){var e=AI.findAllByType(b,GroupType.\u7035\u7470\u74d9),e=AI.findAllByType(a,GroupType.\u7035\u7470\u74d9,e[0]),g=AI.findAllByType(b,GroupType.\u6d93\u590a\u7d36),g=AI.findAllByType(a,GroupType.\u6d93\u590a\u7d36,g[0]);if(0<g.length){e=g[g.length-1];c=AI.findPlusPoker(a,e,2,!0);if(!c||14<=c[c.length-1].point)c=AI.findPlusPoker(a,e,1,!1);if(!c||15<=c[c.length-1].point)c=e}else 0<e.length&&(c=e[e.length-1])}c&&(this.freePlayer=
a);c||1!=b.pokers.length&&2!=b.pokers.length||(b=AI.findAllByType(a,GroupType.\u9357\u66de\u7d36),0<b.length&&(c=b[0]))}}Poker.select(c||d,!0);this.playPoker(a)}};
ddz.playPoker=function(a){var b=a.getSelectedPokers(),d=Rule.getType(b),c=b.length;if(null!=d&&0!=c){trace("playPoker:",a,d,b);this.lastType=d;this.lastPokers=b;this.lastWinner=a;a.lastPokers=b;a.deletePokers(b);if(a==this.user){this.showControlButtons(!1);for(var e=this.width-R.pokerfg.m[2]>>1,g=this.height-R.pokerfg.m[3]-100>>0,f=0==c%2?0.5*(c-1):Math.floor(0.5*c),h=0;h<c;h++){var k=b[h];this.pokerStage.removeChild(k);k=new Poker(k.point,k.type,"m");k.x=e+15*(h-f)>>0;k.y=g;if(0==h)var l=k.x;k._render(this.playerStage.context)}this.lastRect[0]=
new Rectangle(l,g,Math.round(15*(c-1)+k.width),k.height);this.resortPokers(!1,!0);this.pokerStage.render()}else if(h=this.players.indexOf(a),e=19<=c?10:9,1==h){g=this.width-46-R.pokerfg.m[2]-15*Math.min(c,e)>>0;for(h=0;h<c;h++)k=b[h],k=new Poker(k.point,k.type,"m"),k.x=g+h%e*15,k.y=h<e?45:60,0==h&&(l=k.x),k._render(this.infoStage.context);this.lastRect[1]=new Rectangle(l,45,Math.round(15*(Math.min(c,e)-1)+R.pokerfg.m[2]),Math.round(R.pokerfg.m[3]+(c>e?18:0)))}else if(2==h){for(h=0;h<c;h++)k=b[h],
k=new Poker(k.point,k.type,"m"),k.x=62+h%e*15,k.y=h<e?45:60,0==h&&(l=k.x),k._render(this.infoStage.context);this.lastRect[2]=new Rectangle(l,45,Math.round(15*(Math.min(c,e)-1)+R.pokerfg.m[2]),Math.round(R.pokerfg.m[3]+(c>e?18:0)))}if(d==GroupType.\u9359\u5c80\u5e07||d==GroupType.\u9410\u7a3f\u810a)this.scoreRate*=2,this.setBaseScoreAndRate(null,this.scoreRate);a!=this.user&&(a.pokerCount.fastClear(null,!0),UI.renderNumber(this.playerStage.context,a.pokerCount,a.pokers.length));0>=a.pokers.length?
(this.turnWinner=a,setTimeout(casual.delegate(this.gameOver,this),this.turnInterval)):this.nextTurn(!0)}};
ddz.skipPlay=function(a){trace("skipPlay:",a,this.lastType);switch(this.playTurn){case 0:this.showControlButtons(!1);UI.showBubble(!0,"noplay",!1,this.playerStage,100,this.height-160);this.lastRect[0]=new Rectangle(58,this.height-160,84,48);break;case 1:UI.showBubble(!0,"noplay",!0,this.infoStage,this.width-100,40);this.lastRect[1]=new Rectangle(this.width-100-42,40,84,48);break;case 2:UI.showBubble(!0,"noplay",!1,this.infoStage,100,40),this.lastRect[2]=new Rectangle(58,40,84,48)}a.clearLastPokers();
this.pokerStage.render();this.nextTurn(!0)};
ddz.gameOver=function(){for(var a=0;a<this.players.length;a++){var b=this.players[a],d=this.lastRect[a];if(d){var c=0==a?this.playerStage:this.infoStage;(b!=this.turnWinner||b==this.user&&58==d.x)&&c.clear(d.x,d.y,d.width,d.height)}if(b!=this.turnWinner&&b!=this.user)if(d=b.pokers.length,c=19<=d?10:9,1==a)for(var e=this.width-46-R.pokerfg.m[2]-15*Math.min(d,c)>>0,g=0;g<d;g++){var f=b.pokers[g],f=new Poker(f.point,f.type,"m");f.x=e+g%c*15;f.y=g<c?45:60;f._render(this.infoStage.context)}else if(2==a)for(g=
0;g<d;g++)f=b.pokers[g],f=new Poker(f.point,f.type,"m"),f.x=62+g%c*15,f.y=g<c?45:60,f._render(this.infoStage.context)}d=this.baseScore*this.scoreRate;c=[];for(a=0;a<this.players.length;a++)b=this.players[a],c[a]=b==this.turnWinner||this.turnWinner!=this.dizhu&&b!=this.dizhu?b==this.dizhu?2*d:d:b==this.dizhu?2*-d:-d,b.score=parseInt(b.score),b.score+=parseInt(c[a]),this.saveLocalData(),0==a&&(this.showText("score0",!1),Gamehub1&&Gamehub.Score.submitHide(this.user.score)),
e=Level.getLevel(b.score),e!=b.level&&(b==this.user&&Level.compare(e,b)&&(Gamehub1.Level.update(e.title),trace("upgrade",b,e)),b.level=e);trace("gameOver:","winner:",this.turnWinner,"myScore:",this.user.score);setTimeout(casual.delegate(this.playAnimation,this),1E3,c)};
ddz.playAnimation=function(a){var b=this.createCanvas("modal",{width:this.width,height:this.height}),d=b.getContext("2d");d.globalAlpha=0.5;d.fillStyle="#000000";d.fillRect(0,0,b.width,b.height);this.container.appendChild(b);var c=this.createCanvas("result",{width:this.width,height:this.height}),e=c.getContext("2d"),g=new Stage(e);g.setFrameRate(0);g.mouseEnabled=!1;this.container.appendChild(c);var f=this.turnWinner==this.dizhu?R.dizhuWin:R.poolWin;f.alpha=1;f.oldx=f.x=c.width-f.width>>1;f.oldy=
f.y=c.height;g.addChild(f);f.fastRender(e);TweenUtil.to(f,200,{y:(c.height-f.height>>1)-20,onUpdate:function(){f.fastRender(e)},onComplete:function(){f.fastRender(e);ddz.playScoreAnimation(a);setTimeout(function(){TweenUtil.to(f,200,{y:-f.height,alpha:0,onUpdate:function(){f.fastRender(g.context)},onComplete:function(){f.fastClear();f.stage=null;ddz.container.removeChild(c);ddz.container.removeChild(b);for(var a=0;a<ddz.players.length;a++){var d=ddz.players[a];void 0!=d.scoreInterval&&(clearInterval(d.scoreInterval),
delete d.scoreInterval)}ddz.resetGame()}})},2500)}})};
ddz.playScoreAnimation=function(a){for(var b=this.playerStage,d=0;d<this.players.length;d++){var c=this.players[d],e=c.pokerCount;e.fastClear(null,!0);var g=c.score,f=g-a[d],e=UI.getNumber(e,f,!0);1==d&&50<e.width&&(e.x=Math.min(e.x,50-e.width));e.fastRender(b.context,!1,!0);c.scoreInterval=setInterval(function(a){a.start!=a.end?(a.start<a.end?a.start++:a.start--,a.target.fastClear(null,!0),1==a.id&&(a.target.x=Math.min(a.target.x,50-a.target.width)),UI.renderNumber(b.context,a.target,a.start,!0)):
(a.target.fastClear(null,!0),1==a.id&&(a.target.x=Math.min(a.target.x,50-a.target.width)),UI.renderNumber(b.context,a.target,a.start,!0),a.target.x=2,a=ddz.players[a.id],clearInterval(a.scoreInterval),delete a.scoreInterval)},100,{id:d,target:e,start:f,end:g})}};
ddz.onPokerSelect=function(a){0==this.playTurn&&(a=a.selected||0<this.user.getSelectedPokers().length?Button.state.UP:Button.state.DISABLED,this.controlBtns.resetBtn.state!=a&&(this.controlBtns.resetBtn.setState(a),this.controlBtns.resetBtn.fastRender(this.controlStage.context)),this.controlBtns.playBtn.state!=a&&(this.controlBtns.playBtn.setState(a),this.controlBtns.playBtn.fastRender(this.controlStage.context)))};
ddz.resortPokers=function(a,b){AI.sort1(this.user.pokers);for(var d=this.user.pokers.length,c=Math.floor((this.pokerStage.getStageWidth()-20-R.pokerWidth)/(d-1)),c=Math.max(21,Math.min(30,c)),e=this.pokerStage.getStageWidth()-c*(d-1)-R.pokerWidth>>1,g=this.pokerStage.getStageHeight()-R.pokerHeight-2,f=0;f<d;f++){var h=this.user.pokers[f];h.x=e+c*f;h.y=g;h.mouseEnabled=b;a&&(this.pokerStage.removeChild(h),this.pokerStage.addChild(h))}};
ddz.showControlButtons=function(a){if(!this.controlBtns){var b=new Sprite;this.controlBtns=b;var d=UI.playBtn;d.x=this.controlStage.getStageWidth()-d.width;b.playBtn=d;var c=UI.tipBtn;c.x=d.x-c.width-10;c.name="tipBtn";b.tipBtn=c;var e=UI.resetBtn;e.x=c.x-e.width-10;b.resetBtn=e;var g=UI.skipBtn;g.x=20;b.skipBtn=g;b.addChild(d);b.addChild(c);b.addChild(e);b.addChild(g);g.onMouseUp=function(a){this.stage=null;a=ddz.user.getSelectedPokers();0<a.length&&Poker.select(a,!1);ddz.skipPlay(ddz.user)};e.onMouseUp=
function(a){a=ddz.user.getSelectedPokers();0<a.length&&(Poker.select(a,!1),ddz.pokerStage.render())};c.onMouseUp=function(a){a=ddz.user.getSelectedPokers();0<a.length&&Poker.select(a,!1);ddz.lastType?(null==ddz.lastTip?(AI.analyzePlayerPokers(ddz.user),ddz.lastTip=AI.findAllByType(ddz.user,ddz.lastType,ddz.lastPokers,!0),ddz.lastTipIndex=ddz.lastTip.length-1):ddz.lastTipIndex=0<ddz.lastTipIndex?ddz.lastTipIndex-1:ddz.lastTip.length-1,a=ddz.lastTip[ddz.lastTipIndex]):Rule.getType(ddz.user.pokers)?
a=ddz.user.pokers:(AI.analyzePlayerPokers(ddz.user),a=AI.findSmallestType(ddz.user,ddz.user.pokers),!a&&ddz.user.bomb.length&&(a=ddz.user.bomb[ddz.user.bomb.length-1]),!a&&ddz.user.twoking.length&&(a=ddz.user.twoking[ddz.user.twoking.length-1]));a?(Poker.select(a,!0),ddz.pokerStage.render()):(this.stage=null,ddz.skipPlay(ddz.user))};d.onMouseUp=function(a){a=ddz.user.getSelectedPokers();0!=a.length&&Rule.getType(a)&&(null!=ddz.lastPokers?Rule.compare(a,ddz.lastPokers)&&(this.stage=null,ddz.playPoker(ddz.user)):
(this.stage=null,ddz.playPoker(ddz.user)))}}a?(this.controlBtns.skipBtn.setState(null!=this.lastPokers?Button.state.UP:Button.state.DISABLED),0<this.user.getSelectedPokers().length?(this.controlBtns.playBtn.setState(Button.state.UP),this.controlBtns.resetBtn.setState(Button.state.UP)):(this.controlBtns.playBtn.setState(Button.state.DISABLED),this.controlBtns.resetBtn.setState(Button.state.DISABLED)),this.controlStage.addChild(this.controlBtns),this.controlBtns.fastRender(this.controlStage.context)):
(this.controlStage.removeChild(this.controlBtns),this.controlBtns.skipBtn.stage=null,this.controlBtns.resetBtn.stage=null,this.controlBtns.tipBtn.stage=null,this.controlBtns.playBtn.stage=null,this.controlStage.clear())};
